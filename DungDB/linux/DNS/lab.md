# Cấu hình DNS Server trên CentOS 7



## Cài đặt DNS server

Kịch bản: 

Trong bài lab này có 3 node, 1 node là Master DNS server, 1 node là Slave DNS server, 1 node là Client

Mô hình:

![Imgur](https://i.imgur.com/2JiSSrO.png)

### Cài đặt Master DNS server

Cài các gói bind9

    yum install bind bind-utils -y

1. Cấu hình DNS Server

Sửa file `/etc/named.conf`

    vi /etc/named.conf

Trong phần options, sửa các dòng:

    listen-on port 53 { 127.0.0.1; 10.10.34.171;}; ### Master DNS IP ###
    allow-query     { localhost; 10.10.34.0/24;}; ### IP Range ###
    allow-transfer{ localhost; 10.10.34.176; };   ### Slave DNS IP ###

Và thêm các dòng sau vào cuối file

    zone "dung.db" IN {
    type master;
    file "forward.dung";
    allow-update { none; };
    };
    zone "34.10.10.in-addr.arpa" IN {
    type master;
    file "reverse.dung";
    allow-update { none; };
    };

2. Tạo file forward và reverse zone mà ta đã nêu trong file `/etc/named.conf`

Tạo file `forward.dung` trong thư mục `/var/named`

    vi /var/named/forward.dung

Thêm vào nội dung

    $TTL 86400
    @   IN  SOA     masterdns.dung.db. root.dung.db. (
            2011071001  ;Serial
            3600        ;Refresh
            1800        ;Retry
            604800      ;Expire
            86400       ;Minimum TTL
    )
    @       IN  NS          masterdns.dung.db.
    @       IN  NS          secondarydns.dung.db.
    @       IN  A           10.10.34.171
    @       IN  A           10.10.34.176
    @       IN  A           10.10.34.174
    masterdns       IN  A   10.10.34.171
    secondarydns    IN  A   10.10.34.176
    client          IN  A   10.10.34.174

Tạo file `reverse.dung` trong thư mục `/var/named`

    vi /var/named/reverse.dung

Nội dung

    $TTL 86400
    @   IN  SOA     masterdns.dung.db. root.dung.db. (
            2011071001  ;Serial
            3600        ;Refresh
            1800        ;Retry
            604800      ;Expire
            86400       ;Minimum TTL
    )
    @       IN  NS          masterdns.dung.db.
    @       IN  NS          secondarydns.dung.db.
    @       IN  PTR         dung.db.
    masterdns       IN  A   10.10.34.171
    secondarydns    IN  A   10.10.34.176
    client          IN  A   10.10.34.174
    171     IN  PTR         masterdns.dung.db.
    176     IN  PTR         secondarydns.dung.db.
    174     IN  PTR         client.dung.db.

3. Khởi động dịch vụ DNS

        systemctl enable named
        systemctl start named

4. Cấu hình firewall

        firewall-cmd --permanent --add-port=53/tcp
        firewall-cmd --permanent --add-port=53/udp
        firewall-cmd --reload

5. Phân quyền, quyền sở hữu

        chgrp named -R /var/named
        chown -v root:named /etc/named.conf
        restorecon -rv /var/named
        restorecon /etc/named.conf

6. Test cấu hình 

Check cấu hình mặc định:

    named-checkconf /etc/named.conf

Nếu không có thông báo gì là OK

Check Forward zone:

    named-checkzone dung.db /var/named/forward.dung

Check reverse zone:

    named-checkzone dung.db /var/named/reverse.dung

Output mẫu:

![Imgur](https://i.imgur.com/Ofjea9s.png)

Sau đó sửa cấu hình DNS của interface đang sử dụng

    vi /etc/sysconfig/network-scripts/ifcfg-eth0

    # Generated by dracut initrd
    NAME="eth0"
    HWADDR="52:54:00:6F:58:F6"
    ONBOOT="yes"
    NETBOOT="yes"
    UUID="2f4c9fa1-1511-4da5-912b-2f2d66029920"
    IPV6INIT="yes"
    BOOTPROTO="static"
    TYPE="Ethernet"
    PROXY_METHOD="none"
    BROWSER_ONLY="no"
    DEFROUTE="yes"
    IPV4_FAILURE_FATAL="no"
    IPV6_AUTOCONF="yes"
    IPV6_DEFROUTE="yes"
    IPV6_FAILURE_FATAL="no"
    IPADDR=10.10.34.171
    PREFIX=24
    GATEWAY=10.10.34.1
    DNS=10.10.34.171

Sửa file `/etc/resolv.conf`

    vi /etc/resolv.conf

Thêm IP của name server

    nameserver 10.10.34.171

![Imgur](https://i.imgur.com/qGU3B8W.png)

Restart dịch vụ mạng

    systemctl restart network

7. Kiểm tra DNS server 

        dig masterdns.dung.db

![Imgur](https://i.imgur.com/7K1n2xK.png)

    nslookup dung.db

![Imgur](https://i.imgur.com/aQhGUdy.png)

Như vậy ta đã cấu hình xong Primary Name Server (Master)

Bây giờ cấu cài đặt và cấu hình Secondary Name Server (Slave)

### Cấu hình Slave DNS Server

Cài các gói bind9

    yum install bind bind-utils -y

1. Cấu hình DNS Server

Sửa file `/etc/named.conf`

    vi /etc/named.conf

Trong phần options, sửa các dòng:

    listen-on port 53 { 127.0.0.1; 10.10.34.176; };
    allow-query     { localhost; 10.10.34.0/24;  };

Và thêm các dòng sau vào cuối file

    zone "dung.db" IN {
    type slave;
    file "slaves/dung.fwd";
    masters { 10.10.34.171; };
    };
    zone "34.10.10.in-addr.arpa" IN {
    type slave;
    file "slaves/dung.rev";
    masters { 10.10.34.171; };
    };

2. Khởi động dịch vụ

        systemctl enable named
        systemctl start named

Bây giờ forward và reverse zone sẽ được tự động cập nhật từ Master DNS server sang file `/var/named/slaves/` của Secondary DNS server

    ls /var/named/slaves/

![Imgur](https://i.imgur.com/ccJLdSr.png)

3. Thêm thông tin DNS vào file cấu hình interface đang sử dụng

        vi /etc/sysconfig/network-scripts/ifcfg-eth1

Thêm thông tin DNS

    DNS1=10.10.34.171
    DNS2=10.10.34.176

![Imgur](https://i.imgur.com/lU2wjvn.png)

Khởi động lại dịch vụ mạng

    systemctl restart network

4. Cấu hình firewall

        firewall-cmd --permanent --add-port=53/tcp
        firewall-cmd --permanent --add-port=53/udp
        firewall-cmd --reload

5. Phân quyền, quyền sở hữu

        chgrp named -R /var/named
        chown -v root:named /etc/named.conf
        restorecon -rv /var/named
        restorecon /etc/named.conf
6. Test DNS server 

        dig masterdns.dung.db

![Imgur](https://i.imgur.com/gkzriRA.png)

    dig secondarydns.dung.db

![Imgur](https://i.imgur.com/gc85dZE.png)

    nslookup dung.db

![Imgur](https://i.imgur.com/QcZD6XM.png)

### Cấu hình trên Client

    vi /etc/resolv.conf

    search dung.db
    nameserver 10.10.34.171
    nameserver 10.10.34.176

![Imgur](https://i.imgur.com/O7LqDyH.png)

Khởi động lại dịch vụ mạng và reboot máy

    systemctl restart network
    reboot

Test DNS server:

    dig masterdns.dung.db

![Imgur](https://i.imgur.com/K9naYjL.png)

    dig secondarydns.dung.db

![Imgur](https://i.imgur.com/pBwYYC4.png)

    dig client.dung.db

![Imgur](https://i.imgur.com/PWcmp6y.png)

    nslookup dung.db

![Imgur](https://i.imgur.com/fBtLXME.png)

## Tham khảo: 

https://www.unixmen.com/setting-dns-server-centos-7/